parameters:
  - name: azureSubscription
  - name: resourceGroupName
  - name: projectRoot
  - name: pythonVersion
    default: '3.9'
  - name: debug
    type: boolean
    default: false

steps:
  - task: AzurePowerShell@5
    displayName: 'Read Connection String'
    name: readAppInsights
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      ScriptType: 'InlineScript'
      Inline: |
        $appInsightResource = Get-AzApplicationInsights -ResourceGroupName $(resourceGroupName)
        $APPLICATIONINSIGHTS_CONNECTION_STRING = $appInsightResource.ConnectionString
        Write-Host "##vso[task.setvariable variable=connectionString;issecret=true]$APPLICATIONINSIGHTS_CONNECTION_STRING"
      azurePowerShellVersion: 'LatestVersion'
      pwsh: true
    env:
      resourceGroupName: ${{ parameters.resourceGroupName }}

  - task: UsePythonVersion@0
    displayName: 'Use Python ${{ parameters.pythonVersion }}'
    inputs:
      versionSpec: ${{ parameters.pythonVersion }}
      addToPath: true

  - script: |
      python3 -m venv antenv
    displayName: install antenv
    workingDirectory: ${{ parameters.projectRoot }}

  - script: |
      source antenv/bin/activate
      python3 -m pip install --upgrade pip setuptools wheel
      python3 -m pip install -r requirements.txt
    workingDirectory: ${{ parameters.projectRoot }}
    displayName: 'Install tools and Requirements'

  - ${{ if eq(parameters.debug, true) }}:
      - script: |
          echo "Parameters:"
          echo "AZURESUBSCRIPTION: $AZURESUBSCRIPTION"
          echo "RESOURCEGROUPNAME: $RESOURCEGROUPNAME"
          echo "PROJECTROOT: $PROJECTROOT"
          echo "APPLICATIONINSIGHTS_CONNECTION_STRING: $(connectionString)"
          echo "DJANGO_SUPERUSER_EMAIL: $DJANGO_SUPERUSER_EMAIL"
          echo "DJANGO_SUPERUSER_PASSWORD: $DJANGO_SUPERUSER_PASSWORD"
          echo "SECRETKEY: $SECRETKEY"
          echo "SECRET_KEY: $SECRET_KEY"
          echo "SECRET_KEY: $(secretKey)"
          echo "With 'set':"
          set
          echo "With 'env':"
          env
        displayName: debug script env
        continueOnError: true
        env:
          SECRET_KEY: ${{ variables.secretKey }}
          APPLICATIONINSIGHTS_CONNECTION_STRING: $(readAppInsights.connectionString)
          DJANGO_SUPERUSER_EMAIL: $(DJANGO_SUPERUSER_EMAIL)
          DJANGO_SUPERUSER_PASSWORD: $(DJANGO_SUPERUSER_PASSWORD)

      - task: PythonScript@0
        displayName: debug py ${{ parameters.pythonVersion }} environ
        continueOnError: true
        inputs:
          script: |
            import sys
            import os
            print(os.environ)
          workingDirectory: ${{ parameters.projectRoot }}
          scriptSource: inline
        env:
          SECRET_KEY: $(secretKey)
          APPLICATIONINSIGHTS_CONNECTION_STRING: $(readAppInsights.connectionString)
          DJANGO_SUPERUSER_EMAIL: $(DJANGO_SUPERUSER_EMAIL)
          DJANGO_SUPERUSER_PASSWORD: $(DJANGO_SUPERUSER_PASSWORD)

  - script: |
      export SECRET_KEY="$(secretKey)"
      source antenv/bin/activate
      python3 manage.py migrate
      python3 manage.py createsuperuser --noinput
    workingDirectory: ${{ parameters.projectRoot }}
    displayName: 'migrate and create superuser'
    env:
      SECRET_KEY: $(secretKey)
      APPLICATIONINSIGHTS_CONNECTION_STRING: $(readAppInsights.connectionString)
      DJANGO_SUPERUSER_EMAIL: $(DJANGO_SUPERUSER_EMAIL)
      DJANGO_SUPERUSER_PASSWORD: $(DJANGO_SUPERUSER_PASSWORD)

  - task: PythonScript@0
    continueOnError: true
    displayName: Run Tests
    inputs:
      scriptSource: filePath
      scriptPath: manage.py
      arguments: test
      workingDirectory: ${{ parameters.projectRoot }}
    env:
      SECRET_KEY: ${{ variables.secretKey }}
      APPLICATIONINSIGHTS_CONNECTION_STRING: $(readAppInsights.connectionString)
      DJANGO_SUPERUSER_EMAIL: $(DJANGO_SUPERUSER_EMAIL)
      DJANGO_SUPERUSER_PASSWORD: $(DJANGO_SUPERUSER_PASSWORD)
